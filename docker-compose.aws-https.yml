services:
  db:
    image: postgres:16
    container_name: univibe-db
    env_file:
      - .env
    ports:
      - "5433:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - univibe-network
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: univibe-backend
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./backend/.env
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - univibe-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend/web
      dockerfile: Dockerfile.aws-https
      args:
        # IMPORTANTE: Cambiar 3.151.11.170 por tu IP pública de AWS
        # Ejemplo: Si tu IP es 1.2.3.4, usa: https://1.2.3.4
        # 
        # NOTA: Si tienes dominio, también puedes usarlo aquí
        # Ejemplo con dominio: https://univibe.example.com
        #
        # IMPORTANTE: 
        # - Usa https:// (no http://)
        # - NO incluyas el puerto (Nginx escucha en 443 automáticamente)
        # - VITE_WS_BASE_URL debe usar https://, NO wss://
        # - SockJS maneja la actualización a WebSocket internamente
        # 
        # ACTUALIZADO: Usando dominio No-IP: univibeapp.ddns.net
        # IMPORTANTE: Cambia estas URLs por tu dominio o IP pública de AWS
        - VITE_API_BASE_URL=https://univibeapp.ddns.net
        - VITE_WS_BASE_URL=https://univibeapp.ddns.net
    container_name: univibe-frontend
    depends_on:
      - backend
    ports:
      - "443:443"   # HTTPS (puerto 80 está ocupado por Nginx del host)
    volumes:
      # Montar certificados SSL desde el host
      # Asegúrate de tener los certificados en ./ssl/cert.pem y ./ssl/key.pem
      - ./ssl:/etc/nginx/certs:ro
    networks:
      - univibe-network
    restart: unless-stopped

volumes:
  db-data:
    driver: local

networks:
  univibe-network:
    driver: bridge


